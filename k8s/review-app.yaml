# ========================
# Review Service (Spring Boot backend) â€” Zipkin Disabled
# ========================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: review-service
  namespace: movie
spec:
  replicas: 1
  selector:
    matchLabels:
      app: review-service
  template:
    metadata:
      labels:
        app: review-service
    spec:
      initContainers:
        - name: wait-for-review-db
          image: mysql:8.0
          command:
            - sh
            - -c
            - |
              until mysqladmin ping -h review-db -u reviewuser -previewpass >/dev/null 2>&1; do
                echo "waiting for review-db"
                sleep 5
              done
      containers:
        - name: review-service
          image: 543816070942.dkr.ecr.us-east-1.amazonaws.com/bookmyseatreviewservice:1
          ports:
            - containerPort: 8082
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: docker
            - name: SPRING_DATASOURCE_URL
              value: jdbc:mysql://review-db:3306/review_db
            - name: SPRING_DATASOURCE_USERNAME
              value: reviewuser
            - name: SPRING_DATASOURCE_PASSWORD
              value: reviewpass
            - name: MOVIE_SERVICE_BASE_URL
              value: http://movie-service.movie.svc.cluster.local:8081/api/v1/movies
            # Disable Zipkin tracing
            - name: MANAGEMENT_TRACING_ENABLED
              value: "false"
            - name: MANAGEMENT_OTLP_TRACING_ENDPOINT
              value: ""
            - name: ZIPKIN_ENDPOINT
              value: ""
          readinessProbe:
            httpGet:
              path: /actuator/health
              port: 8082
            initialDelaySeconds: 20
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /actuator/health
              port: 8082
            initialDelaySeconds: 60
            periodSeconds: 20
---
apiVersion: v1
kind: Service
metadata:
  name: review-service
  namespace: movie
spec:
  selector:
    app: review-service
  ports:
    - port: 8082
      targetPort: 8082
  type: ClusterIP
