# ========================
# Namespace (reuse movie)
# ========================
apiVersion: v1
kind: Namespace
metadata:
  name: movie
---
# ========================
# PersistentVolumeClaim for review-db
# ========================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: review-db-pvc
  namespace: movie
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: gp2-immediate
  resources:
    requests:
      storage: 1Gi
---
# ========================
# ConfigMap for MySQL initialization
# ========================
apiVersion: v1
kind: ConfigMap
metadata:
  name: review-init-scripts
  namespace: movie
data:
  V1__Create_reviews_and_movie_ratings_tables.sql: |
    -- Create reviews table
    CREATE TABLE reviews (
        id BIGINT AUTO_INCREMENT PRIMARY KEY,
        movie_id BIGINT NOT NULL,
        user_name VARCHAR(100) NOT NULL,
        rating DECIMAL(2,1) NOT NULL CHECK (rating >= 1.0 AND rating <= 5.0),
        comment TEXT,
        review_date TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP(6),
        created_at TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP(6),
        updated_at TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        INDEX idx_movie_id (movie_id),
        INDEX idx_review_date (review_date),
        INDEX idx_rating (rating),
        INDEX idx_user_name (user_name)
    );

    -- Create movie ratings cache table
    CREATE TABLE movie_ratings (
        movie_id BIGINT PRIMARY KEY,
        average_rating DECIMAL(3,2),
        total_reviews INT DEFAULT 0,
        rating_1_count INT DEFAULT 0,
        rating_2_count INT DEFAULT 0,
        rating_3_count INT DEFAULT 0,
        rating_4_count INT DEFAULT 0,
        rating_5_count INT DEFAULT 0,
        last_updated TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        INDEX idx_average_rating (average_rating),
        INDEX idx_total_reviews (total_reviews)
    );
  V2__Insert_sample_reviews.sql: |
      -- Insert sample reviews for different movies
      -- Note: These movie IDs should correspond to movies in the Movie Service

      -- Reviews for Movie ID 1 (Inception)
      INSERT INTO reviews (movie_id, user_name, rating, comment, review_date) VALUES
      (1, 'Alice Johnson', 5.0, 'Absolutely mind-blowing! Christopher Nolan outdid himself with this masterpiece. The concept of dreams within dreams is executed flawlessly.', '2025-09-25 14:30:00'),
      (1, 'Bob Smith', 4.5, 'Great movie with stunning visuals and complex plot. Required multiple viewings to fully appreciate the intricacies.', '2025-09-26 09:15:00'),
      (1, 'Carol Davis', 4.0, 'Impressive cinematography and acting. The plot can be confusing at times but worth the mental effort.', '2025-09-27 18:45:00'),
      (1, 'David Wilson', 5.0, 'One of the best sci-fi movies ever made. The ending still gives me chills every time I watch it.', '2025-09-28 12:20:00'),
      (1, 'Eva Brown', 4.5, 'Leonardo DiCaprio delivers an outstanding performance. The special effects are groundbreaking.', '2025-09-29 16:10:00');

      -- Reviews for Movie ID 2 (The Dark Knight)
      INSERT INTO reviews (movie_id, user_name, rating, comment, review_date) VALUES
      (2, 'Frank Miller', 5.0, 'Heath Ledger\'s Joker is legendary. This movie redefined what superhero films could be.', '2025-09-24 20:30:00'),
      (2, 'Grace Lee', 4.5, 'Dark, gritty, and incredibly well-made. The action sequences are phenomenal.', '2025-09-25 11:45:00'),
      (2, 'Henry Taylor', 5.0, 'A masterclass in filmmaking. Every character is perfectly developed and the story is compelling.', '2025-09-26 15:20:00'),
      (2, 'Iris Chen', 4.0, 'Great superhero movie that feels more like a crime thriller. Heath Ledger was incredible.', '2025-09-27 13:55:00');

      -- Reviews for Movie ID 3 (Interstellar)
      INSERT INTO reviews (movie_id, user_name, rating, comment, review_date) VALUES
      (3, 'Jack Thompson', 4.5, 'Visually stunning space epic with emotional depth. The science is fascinating.', '2025-09-23 19:40:00'),
      (3, 'Kate Anderson', 5.0, 'Made me cry and think at the same time. The relationship between Cooper and Murph is beautiful.', '2025-09-24 14:25:00'),
      (3, 'Liam Garcia', 4.0, 'Amazing visuals and soundtrack. The black hole scenes are breathtaking.', '2025-09-25 21:15:00');

      -- Reviews for Movie ID 4 (The Godfather)
      INSERT INTO reviews (movie_id, user_name, rating, comment, review_date) VALUES
      (4, 'Maria Rodriguez', 5.0, 'The greatest movie ever made. Marlon Brando\'s performance is iconic.', '2025-09-22 16:30:00'),
      (4, 'Nathan Kim', 5.0, 'A timeless classic that gets better with each viewing. The storytelling is perfect.', '2025-09-23 12:45:00'),
      (4, 'Olivia White', 4.5, 'Incredible character development and atmospheric cinematography. A true masterpiece.', '2025-09-24 18:20:00');

      -- Reviews for Movie ID 5 (Pulp Fiction)
      INSERT INTO reviews (movie_id, user_name, rating, comment, review_date) VALUES
      (5, 'Paul Martinez', 4.5, 'Tarantino at his finest. The dialogue is sharp and the storytelling is unique.', '2025-09-21 15:10:00'),
      (5, 'Quinn Johnson', 4.0, 'Non-linear narrative that works brilliantly. Samuel L. Jackson is fantastic.', '2025-09-22 20:35:00'),
      (5, 'Rachel Green', 5.0, 'Cultural phenomenon that changed cinema. Every scene is memorable.', '2025-09-23 11:50:00');

      -- Reviews for Movie ID 6 (Dangal)
      INSERT INTO reviews (movie_id, user_name, rating, comment, review_date) VALUES
      (6, 'Suresh Patel', 5.0, 'Aamir Khan delivers another brilliant performance. Inspiring story of determination.', '2025-09-20 17:25:00'),
      (6, 'Priya Sharma', 4.5, 'Emotional and empowering. The wrestling scenes are incredibly well-choreographed.', '2025-09-21 13:40:00'),
      (6, 'Raj Mehta', 4.0, 'Great family drama with strong performances from all actors, especially the daughters.', '2025-09-22 19:15:00');

      -- Reviews for Movie ID 7 (3 Idiots)
      INSERT INTO reviews (movie_id, user_name, rating, comment, review_date) VALUES
      (7, 'Anjali Gupta', 5.0, 'Perfect blend of comedy and social message. Aamir Khan, R. Madhavan, and Sharman Joshi are excellent.', '2025-09-19 14:50:00'),
      (7, 'Vikram Singh', 4.5, 'Hilarious yet thought-provoking. The message about education system is relevant even today.', '2025-09-20 16:30:00'),
      (7, 'Deepika Reddy', 4.0, 'Entertaining throughout with great music. The friendship portrayed is heartwarming.', '2025-09-21 12:20:00');

      -- Reviews for Movie ID 8 (Avengers: Endgame)
      INSERT INTO reviews (movie_id, user_name, rating, comment, review_date) VALUES
      (8, 'Tony Stark', 5.0, 'Epic conclusion to the Infinity Saga. The final battle is absolutely spectacular.', '2025-09-18 21:45:00'),
      (8, 'Steve Rogers', 4.5, 'Emotional rollercoaster that pays off 11 years of character development perfectly.', '2025-09-19 18:30:00'),
      (8, 'Natasha Romanoff', 4.0, 'Great action sequences and character moments. Some pacing issues but overall satisfying.', '2025-09-20 15:40:00'),
      (8, 'Bruce Banner', 5.0, 'Marvel Studios created something truly special. The time travel plot is handled well.', '2025-09-21 20:10:00');
      ---
# ========================
# MySQL Database (review-db)
# ========================
  apiVersion: apps/v1
  kind: Deployment
  metadata:
  name: review-db
  namespace: movie
spec:
  replicas: 1
  selector:
    matchLabels:
      app: review-db
  template:
    metadata:
      labels:
        app: review-db
    spec:
      containers:
        - name: review-db
          image: mysql:8.0
          env:
            - name: MYSQL_DATABASE
              value: review_db
            - name: MYSQL_USER
              value: reviewuser
            - name: MYSQL_PASSWORD
              value: reviewpass
            - name: MYSQL_ROOT_PASSWORD
              value: rootpass
          ports:
            - containerPort: 3306
          volumeMounts:
            - name: review-db-data
              mountPath: /var/lib/mysql
            - name: init-db
              mountPath: /docker-entrypoint-initdb.d/
          livenessProbe:
            exec:
              command: ["mysqladmin", "ping", "-h", "localhost"]
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            exec:
              command: ["mysqladmin", "ping", "-h", "localhost"]
            initialDelaySeconds: 20
            periodSeconds: 10
      volumes:
        - name: review-db-data
          persistentVolumeClaim:
            claimName: review-db-pvc
        - name: init-db
          configMap:
            name: review-init-scripts
---
apiVersion: v1
kind: Service
metadata:
  name: review-db
  namespace: movie
spec:
  selector:
    app: review-db
  ports:
    - port: 3306
      targetPort: 3306
      protocol: TCP
---
# ========================
# Review Service (Spring Boot backend)
# ========================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: review-service
  namespace: movie
spec:
  replicas: 1
  selector:
    matchLabels:
      app: review-service
  template:
    metadata:
      labels:
        app: review-service
    spec:
      initContainers:
        - name: wait-for-review-db
          image: mysql:8.0
          command:
            ["sh", "-c", "until mysql -h review-db -u reviewuser -previewpass -e 'SELECT 1' >/dev/null 2>&1; do echo waiting for review-db; sleep 5; done"]
      containers:
        - name: review-service
          image: 543816070942.dkr.ecr.us-east-1.amazonaws.com/reviewapp-backend:1
          ports:
            - containerPort: 8082
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: docker
            - name: SPRING_DATASOURCE_URL
              value: jdbc:mysql://review-db:3306/review_db
            - name: SPRING_DATASOURCE_USERNAME
              value: reviewuser
            - name: SPRING_DATASOURCE_PASSWORD
              value: reviewpass
            - name: MOVIE_SERVICE_BASE_URL
              value: http://movie-service:8081
            - name: ZIPKIN_ENDPOINT
              value: http://zipkin:9411/api/v2/spans
---
apiVersion: v1
kind: Service
metadata:
  name: review-service
  namespace: movie
spec:
  selector:
    app: review-service
  ports:
    - port: 8082
      targetPort: 8082
  type: LoadBalancer
